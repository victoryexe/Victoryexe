<html>
<head>
<title>CSharpAndPHPCompatibility.cs</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.ln { color: #999999; font-weight: normal; font-style: normal; }
.s0 { color: rgb(0,0,128); font-weight: bold; }
.s1 { color: rgb(0,0,0); }
.s2 { color: rgb(0,128,0); font-weight: bold; }
.s3 { color: rgb(128,128,128); font-style: italic; }
.s4 { color: rgb(0,0,255); }
</style>
</head>
<BODY BGCOLOR="#ffffff">
<TABLE CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<TR><TD><CENTER>
<FONT FACE="Arial, Helvetica" COLOR="#000000">
CSharpAndPHPCompatibility.cs</FONT>
</center></TD></TR></TABLE>
<pre>
<span class="s0">using </span><span class="s1">PasswordSecurity; 
</span><span class="s0">using </span><span class="s1">System; 
</span><span class="s0">using </span><span class="s1">System.Text; 
</span><span class="s0">using </span><span class="s1">System.Diagnostics; 
 
</span><span class="s0">class </span><span class="s1">CSharpAndPHPCompatibility 
{ 
    </span><span class="s0">private struct </span><span class="s1">CommandExecResult 
    { 
        </span><span class="s0">public int </span><span class="s1">exitCode; 
        </span><span class="s0">public string </span><span class="s1">stdOut; 
    } 
 
    </span><span class="s0">public static void </span><span class="s1">Main() 
    { 
       testCSharpHashes(); 
       testPHPHashes(); 
    } 
 
    </span><span class="s0">private static void </span><span class="s1">testCSharpHashes() 
    { 
        </span><span class="s0">string </span><span class="s1">userPW = </span><span class="s2">&quot;test_password&quot;</span><span class="s1">; 
        </span><span class="s0">string </span><span class="s1">goodHash = PasswordStorage.CreateHash(userPW); 
 
        </span><span class="s3">// Good password.</span><span class="s1"> 
        </span><span class="s0">string </span><span class="s1">args = </span><span class="s2">&quot;tests/phpVerify.php&quot; </span><span class="s1">+ </span><span class="s2">&quot; &quot; </span><span class="s1">+ userPW + </span><span class="s2">&quot; &quot; </span><span class="s1">+ goodHash; 
        CommandExecResult goodHashExecution = RunCommand(</span><span class="s2">&quot;php&quot;</span><span class="s1">, args); 
        </span><span class="s0">if </span><span class="s1">(goodHashExecution.exitCode == </span><span class="s4">0</span><span class="s1">) 
        { 
            Console.WriteLine(</span><span class="s2">&quot;C# hash valdating in PHP: pass&quot;</span><span class="s1">); 
        } 
        </span><span class="s0">else if </span><span class="s1">(goodHashExecution.exitCode == </span><span class="s4">1</span><span class="s1">) 
        { 
            Console.WriteLine(</span><span class="s2">&quot;C# hash validating in PHP: FAIL&quot;</span><span class="s1">); 
            System.Environment.Exit(</span><span class="s4">1</span><span class="s1">); 
        } 
 
        </span><span class="s3">// Bad password.</span><span class="s1"> 
        args = </span><span class="s2">&quot;tests/phpVerify.php&quot; </span><span class="s1">+ </span><span class="s2">&quot; &quot; </span><span class="s1">+ </span><span class="s2">&quot;wrongPassword&quot; </span><span class="s1">+ </span><span class="s2">&quot; &quot; </span><span class="s1">+ goodHash; 
        CommandExecResult badHashExecution = RunCommand(</span><span class="s2">&quot;php&quot;</span><span class="s1">, args); 
        </span><span class="s0">if </span><span class="s1">(badHashExecution.exitCode == </span><span class="s4">0</span><span class="s1">) 
        { 
            Console.WriteLine(</span><span class="s2">&quot;C# hash validating wrong password in PHP: FAIL&quot;</span><span class="s1">); 
            System.Environment.Exit(</span><span class="s4">1</span><span class="s1">); 
        } 
        </span><span class="s0">else if </span><span class="s1">(badHashExecution.exitCode == </span><span class="s4">1</span><span class="s1">) 
        { 
            Console.WriteLine(</span><span class="s2">&quot;C# hash validating wrong password in PHP: pass&quot;</span><span class="s1">); 
        } 
    } 
 
    </span><span class="s0">private static void </span><span class="s1">testPHPHashes() 
    { 
        </span><span class="s0">string</span><span class="s1">[] testData = </span><span class="s0">null</span><span class="s1">; 
        </span><span class="s0">char</span><span class="s1">[] useDelimiter = { </span><span class="s2">' ' </span><span class="s1">}; 
 
        </span><span class="s3">// Good password.</span><span class="s1"> 
        CommandExecResult goodHashExecution = RunCommand(</span><span class="s2">&quot;php&quot;</span><span class="s1">, </span><span class="s2">&quot;tests/phpHashMaker.php&quot;</span><span class="s1">); 
        testData = goodHashExecution.stdOut.Split(useDelimiter); 
 
        </span><span class="s0">if </span><span class="s1">(testData[</span><span class="s4">1</span><span class="s1">].Length != Int32.Parse(testData[</span><span class="s4">0</span><span class="s1">])) { 
            Console.WriteLine(</span><span class="s2">&quot;Unicode test is invalid.&quot;</span><span class="s1">); 
            System.Environment.Exit(</span><span class="s4">1</span><span class="s1">); 
        } 
 
        </span><span class="s0">if </span><span class="s1">(PasswordStorage.VerifyPassword(testData[</span><span class="s4">1</span><span class="s1">], testData[</span><span class="s4">2</span><span class="s1">])) 
        { 
            Console.WriteLine(</span><span class="s2">&quot;PHP hash validating in C#: pass&quot;</span><span class="s1">); 
        } 
        </span><span class="s0">else</span><span class="s1"> 
        { 
            Console.WriteLine(</span><span class="s2">&quot;PHP hash validating in C#: FAIL&quot;</span><span class="s1">); 
            System.Environment.Exit(</span><span class="s4">1</span><span class="s1">); 
        } 
 
        </span><span class="s3">// Bad password.</span><span class="s1"> 
        CommandExecResult badHashExecution = RunCommand(</span><span class="s2">&quot;php&quot;</span><span class="s1">, </span><span class="s2">&quot;tests/phpHashMaker.php&quot;</span><span class="s1">); 
        testData = badHashExecution.stdOut.Split(useDelimiter); 
 
        </span><span class="s0">if </span><span class="s1">(testData[</span><span class="s4">1</span><span class="s1">].Length != Int32.Parse(testData[</span><span class="s4">0</span><span class="s1">])) { 
            Console.WriteLine(</span><span class="s2">&quot;Unicode test is invalid.&quot;</span><span class="s1">); 
            System.Environment.Exit(</span><span class="s4">1</span><span class="s1">); 
        } 
 
        </span><span class="s0">if </span><span class="s1">(PasswordStorage.VerifyPassword(</span><span class="s2">&quot;wrongPassword&quot;</span><span class="s1">, testData[</span><span class="s4">2</span><span class="s1">])) 
        { 
            Console.WriteLine(</span><span class="s2">&quot;The C# implementation accepts BAD PHP hashes: FAIL&quot;</span><span class="s1">); 
            System.Environment.Exit(</span><span class="s4">1</span><span class="s1">); 
        } 
        </span><span class="s0">else</span><span class="s1"> 
        { 
            Console.WriteLine(</span><span class="s2">&quot;The C# implementation will not accept bad PHP hashes: pass&quot;</span><span class="s1">); 
        } 
    } 
 
    </span><span class="s0">private static </span><span class="s1">CommandExecResult RunCommand(String processName, String args) 
    { 
        Process p = </span><span class="s0">new </span><span class="s1">Process(); 
        </span><span class="s0">string </span><span class="s1">output = </span><span class="s2">&quot;&quot;</span><span class="s1">; 
 
        p.StartInfo.FileName = processName; 
        p.StartInfo.WorkingDirectory = </span><span class="s2">&quot;..&quot;</span><span class="s1">; 
        p.StartInfo.Arguments = args; 
        p.StartInfo.UseShellExecute = </span><span class="s0">false</span><span class="s1">; 
        p.StartInfo.RedirectStandardOutput = </span><span class="s0">true</span><span class="s1">; 
        </span><span class="s0">try</span><span class="s1"> 
        { 
            p.Start(); 
 
            output = p.StandardOutput.ReadToEnd(); 
            p.WaitForExit(); 
        } 
        </span><span class="s0">catch </span><span class="s1">(Exception e) 
        { 
            Console.WriteLine(e.Message); 
            System.Environment.Exit(</span><span class="s4">1</span><span class="s1">); 
        } 
 
        CommandExecResult cmdResult; 
        cmdResult.exitCode = p.ExitCode; 
        cmdResult.stdOut = output; 
 
        </span><span class="s0">return </span><span class="s1">cmdResult; 
    } 
} 
</span></pre>
</body>
</html>